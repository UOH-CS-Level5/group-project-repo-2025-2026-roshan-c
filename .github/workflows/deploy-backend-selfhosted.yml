name: Deploy backend (self-hosted Windows)

on:
  push:
    paths:
      - "icalapp/backend/**"
      - ".github/workflows/deploy-backend-selfhosted.yml"
  workflow_dispatch:

concurrency:
  group: deploy-backend-selfhosted
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: [self-hosted, Windows, X64]
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build image
        run: docker build -t icalapp-backend:latest ./icalapp/backend

      - name: Remove existing container
        shell: pwsh
        run: |
          $existing = docker ps -aq --filter "name=^icalapp-backend$"
          if ($existing) {
            docker rm -f icalapp-backend | Out-Null
          }

      - name: Run container
        run: docker run -d --name icalapp-backend --restart unless-stopped -p 3000:3000 -e PORT=3000 -v icalapp-backend-data:/app/data icalapp-backend:latest

      - name: Health check
        shell: pwsh
        run: |
          $healthy = $false

          for ($attempt = 1; $attempt -le 12; $attempt++) {
            try {
              $response = Invoke-WebRequest -Uri "http://localhost:3000/api/health" -UseBasicParsing -TimeoutSec 5
              if ($response.StatusCode -eq 200) {
                $healthy = $true
                break
              }
            } catch {
            }

            Start-Sleep -Seconds 5
          }

          if (-not $healthy) {
            docker logs --tail 200 icalapp-backend
            throw "Health check failed for icalapp-backend."
          }
